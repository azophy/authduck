{{define "base_template_path"}}resources/views/layout_base.html{{end}}

{{define "title"}}
Authduck | Generic OIDC Callback
{{end}}

{{define "body"}}
<article>
  <figure>
    <img src="./tacit_logo.png" alt="tacit logo" style="max-height: 100px;"/>
  </figure>
  <h1>Callback Endpoint</h1>
  <p>
  This is the <strong>callback</strong> page of Authduck. Usually this page is accessed when the OIDC client initiating the authorization code flow.</p>

  <a href="#" target="_blank" id="client_history_link">see client history</a>

  <form action="." method="post">

  <h2>Request</h2>
  <p>This is the details of request made to this page:</p>
  <textarea id="request_payload" style="width:100%" rows="5" disabled></textarea>

  <h2>Callback Payload</h2>
  <p>This is the details of payload which would be used as callback query params:</p>
  <textarea id="callback_payload" name="callback_payload" style="width:100%" rows="5"></textarea>

  <h2>Code Exchange Payload</h2>
  <p>This is the details of payload which would be returned when client exchanging the authorization code :</p>
  <textarea id="code_exchange_payload" name="code_exchange_payload" style="width:100%" rows="5"></textarea>

  <button type="submit">Continue OIDC Process</button>
  </form>

</article>
<script>
  // ref: https://cheatsheets.zip/generate-a-random-string-with-given-length
  const generateString = length => Array(length).fill('').map((v) => Math.random().toString(36).charAt(2)).join('')

  const queryParams = new URLSearchParams(window.location.search)
  const requestPayload = document.getElementById('request_payload')
  const callbackPayload = document.getElementById('callback_payload')
  const codeExhangePayload = document.getElementById('code_exchange_payload')
  const callbackCode = generateString(20)

  requestPayload.value = JSON.stringify(Object.fromEntries(queryParams.entries()), null, 2)

  callbackPayload.innerHTML = JSON.stringify({
    redirect_uri: queryParams.get('redirect_uri'),
    state: queryParams.get('state'),
    code: callbackCode,
  }, null, 2)

  document.getElementById('client_history_link').href = `/manage/history?id=${queryParams.get('client_id')}`

</script>
{{end}}
