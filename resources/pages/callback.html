<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="keywords" content="css, html5, css framework"/>
    <meta name="description" content="OpenID Connect Server Playground for Development & Learning"/>
    <link rel="stylesheet" href="/assets/tacit.min.css"/>
    <title>Authduck</title>
    <link rel="icon" type="image/png" href="/assets/logo.png"/>
  </head>
  <body>
    <section>
      <header>
        <nav>
          <ul>
            <li><a href=".">home</a></li>
            <li><a href=".">about</a></li>
            <li><a href=".">projects</a></li>
            <li><a href=".">talks</a></li>
          </ul>
        </nav>
      </header>
      <article>
        <figure>
          <img src="./tacit_logo.png" alt="tacit logo" style="max-height: 100px;"/>
        </figure>
        <h1>Callback Endpoint</h1>
        <p>
        This is the <strong>callback</strong> page of Authduck. Usually this page is accessed when the OIDC client initiating the authorization code flow.</p>

        <h2>Request</h2>
        <p>This is the details of request made to this page:</p>
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody id="request-params-table"></tbody>
        </table>

        <h2>Callback Payload</h2>
        <p>This is the details of payload which would be used as callback query params:</p>
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody id="callback-payload-table">
          </tbody>
        </table>

        <button type="submit" onclick="redirectToCallback()">Return to client</button>

      </article>
      <footer>
        <nav>
          <ul>
            <li>
              <small>Made by <a target="_blank" href="https://abdurrahman.adianto.id">azophy</a>, 2024</small>
            </li>
            <li>Styled using <small><a href="https://github.com/yegor256/tacit">tacit</a></small></li>
          </ul>
        </nav>
      </footer>
    </section>
  </body>
  <script>
    // ref: https://cheatsheets.zip/generate-a-random-string-with-given-length
    const generateString = length => Array(length).fill('').map((v) => Math.random().toString(36).charAt(2)).join('')

    const queryParams = new URLSearchParams(window.location.search)
    const requestParamTable = document.getElementById('request-params-table')
    const callbackPayloadTable = document.getElementById('callback-payload-table')
    const callbackCode = generateString(20)

    Array.from(queryParams.entries()).map(
      row => requestParamTable.innerHTML += `
          <tr>
            <td>${row[0]}</td>
            <td>${row[1]}</td>
          </tr>
      `
    )

    callbackPayloadTable.innerHTML += `
          <tr>
            <td>callback url</td>
            <td>${queryParams.get('redirect_uri')}</td>
          </tr>
          <tr>
            <td>state</td>
            <td>${queryParams.get('state')}</td>
          </tr>
          <tr>
            <td>code</td>
            <td>${callbackCode}</td>
          </tr>
    `

    function redirectToCallback() {
      let finalCallbackUrl = new URL(queryParams.get('redirect_uri'))

      finalCallbackUrl.searchParams.set('state', queryParams.get('state'))
      finalCallbackUrl.searchParams.set('code', callbackCode)

      if (window.confirm(`Are you sure you want to redirect to ${finalCallbackUrl} ?`)) {
        window.location = finalCallbackUrl
      }
    }
  </script>
</html>
